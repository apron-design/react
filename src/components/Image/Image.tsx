import React, { forwardRef, useState, useEffect } from 'react';
import type { ImgHTMLAttributes } from 'react';
import './Image.scss';

export type ImageObjectFit = 'contain' | 'cover' | 'fill' | 'none' | 'scale-down';

export interface ImageProps extends Omit<ImgHTMLAttributes<HTMLImageElement>, 'placeholder'> {
  /** 图片地址 */
  src?: string;
  /** 图片填充方式 */
  objectFit?: ImageObjectFit;
}

// 默认占位图标
const PlaceholderIcon = () => (
  <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path
      d="M36.6667 21.6375V30C36.6667 32.5312 34.6146 34.5833 32.0833 34.5833H7.91666C5.38541 34.5833 3.33333 32.5312 3.33333 30V9.99999C3.33333 7.46874 5.38541 5.41666 7.91666 5.41666H32.0833C34.6146 5.41666 36.6667 7.46874 36.6667 9.99999V21.6375ZM34.1667 18.7225V9.99999C34.1667 9.7264 34.1128 9.45549 34.0081 9.20273C33.9034 8.94997 33.7499 8.72031 33.5565 8.52685C33.363 8.3334 33.1333 8.17994 32.8806 8.07524C32.6278 7.97054 32.3569 7.91666 32.0833 7.91666H7.91666C7.64307 7.91666 7.37217 7.97054 7.1194 8.07524C6.86664 8.17994 6.63698 8.3334 6.44352 8.52685C6.25007 8.72031 6.09661 8.94997 5.99191 9.20273C5.88722 9.45549 5.83333 9.7264 5.83333 9.99999V23.4562C6.3851 23.3743 6.94217 23.3332 7.49999 23.3333C10.1136 23.3295 12.6463 24.2393 14.66 25.9054C16.6808 20.64 21.7542 17.0833 27.5 17.0833C30.0667 17.0833 32.4608 17.7387 34.1667 18.7225ZM34.1667 21.935C33.9583 21.61 33.3412 21.0892 32.4617 20.6492C31.1237 19.98 29.4158 19.5833 27.5 19.5833C22.7433 19.5833 18.5496 22.5625 16.9362 26.9542C16.8296 27.245 16.6471 27.7479 16.3896 28.4612C16.0896 29.2933 15.0437 29.5592 14.3829 28.9712C13.7408 28.3996 13.2675 27.9921 12.9712 27.7546C11.4206 26.5078 9.4897 25.8298 7.49999 25.8333C6.93499 25.8333 6.37791 25.8867 5.83333 25.9917V30C5.83333 30.2736 5.88722 30.5445 5.99191 30.7972C6.09661 31.05 6.25007 31.2797 6.44352 31.4731C6.63698 31.6666 6.86664 31.82 7.1194 31.9247C7.37217 32.0294 7.64307 32.0833 7.91666 32.0833H32.0833C32.3569 32.0833 32.6278 32.0294 32.8806 31.9247C33.1333 31.82 33.363 31.6666 33.5565 31.4731C33.7499 31.2797 33.9034 31.05 34.0081 30.7972C34.1128 30.5445 34.1667 30.2736 34.1667 30V21.9346V21.935ZM12.5 18.75C11.5054 18.75 10.5516 18.3549 9.84834 17.6516C9.14508 16.9484 8.74999 15.9946 8.74999 15C8.74999 14.0054 9.14508 13.0516 9.84834 12.3483C10.5516 11.6451 11.5054 11.25 12.5 11.25C13.4946 11.25 14.4484 11.6451 15.1516 12.3483C15.8549 13.0516 16.25 14.0054 16.25 15C16.25 15.9946 15.8549 16.9484 15.1516 17.6516C14.4484 18.3549 13.4946 18.75 12.5 18.75ZM12.5 16.25C12.8315 16.25 13.1495 16.1183 13.3839 15.8839C13.6183 15.6495 13.75 15.3315 13.75 15C13.75 14.6685 13.6183 14.3505 13.3839 14.1161C13.1495 13.8817 12.8315 13.75 12.5 13.75C12.1685 13.75 11.8505 13.8817 11.6161 14.1161C11.3817 14.3505 11.25 14.6685 11.25 15C11.25 15.3315 11.3817 15.6495 11.6161 15.8839C11.8505 16.1183 12.1685 16.25 12.5 16.25Z"
      fill="currentColor"
    />
  </svg>
);

// 加载失败图标
const ErrorIcon = () => (
  <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M9.84833 17.6515C10.5516 18.3548 11.5054 18.7498 12.5 18.7498C13.4945 18.7498 14.4484 18.3548 15.1516 17.6515C15.8549 16.9482 16.25 15.9944 16.25 14.9998C16.25 14.0053 15.8549 13.0514 15.1516 12.3482C14.4484 11.6449 13.4945 11.2498 12.5 11.2498C11.5054 11.2498 10.5516 11.6449 9.84833 12.3482C9.14507 13.0514 8.74998 14.0053 8.74998 14.9998C8.74998 15.9944 9.14507 16.9482 9.84833 17.6515ZM13.3839 15.8837C13.1494 16.1181 12.8315 16.2498 12.5 16.2498C12.1685 16.2498 11.8505 16.1181 11.6161 15.8837C11.3817 15.6493 11.25 15.3314 11.25 14.9998C11.25 14.6683 11.3817 14.3504 11.6161 14.116C11.8505 13.8815 12.1685 13.7498 12.5 13.7498C12.8315 13.7498 13.1494 13.8815 13.3839 14.116C13.6183 14.3504 13.75 14.6683 13.75 14.9998C13.75 15.3314 13.6183 15.6493 13.3839 15.8837Z"
      fill="currentColor"
    />
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M35.4166 25C36.107 25 36.6666 24.4404 36.6666 23.75V9.99984C36.6666 7.46859 34.6146 5.4165 32.0833 5.4165H7.91665C5.3854 5.4165 3.33331 7.46859 3.33331 9.99984V29.9998C3.33331 32.5311 5.3854 34.5832 7.91665 34.5832H24.75C25.4403 34.5832 26 34.0235 26 33.3332C26 32.6428 25.4403 32.0832 24.75 32.0832H7.91665C7.64306 32.0832 7.37215 32.0293 7.11939 31.9246C6.86663 31.8199 6.63696 31.6664 6.44351 31.473C6.25005 31.2795 6.09659 31.0499 5.9919 30.7971C5.8872 30.5443 5.83331 30.2734 5.83331 29.9998V25.9915C6.3779 25.8865 6.93498 25.8332 7.49998 25.8332C9.48968 25.8296 11.4206 26.5077 12.9712 27.7544C13.2675 27.9919 13.7408 28.3994 14.3829 28.9711C15.0437 29.559 16.0896 29.2932 16.3896 28.4611C16.6471 27.7478 16.8296 27.2448 16.9362 26.954C18.5496 22.5623 22.7433 19.5832 27.5 19.5832C29.4158 19.5832 31.1237 19.9798 32.4616 20.649C33.3412 21.089 33.9583 21.6098 34.1666 21.9348V23.75C34.1666 24.4404 34.7263 25 35.4166 25ZM34.1666 9.99984V18.7223C32.4608 17.7386 30.0666 17.0832 27.5 17.0832C21.7541 17.0832 16.6808 20.6398 14.66 25.9053C12.6463 24.2392 10.1136 23.3294 7.49998 23.3332C6.94216 23.3331 6.38509 23.3741 5.83331 23.4561V9.99984C5.83331 9.72625 5.8872 9.45534 5.9919 9.20258C6.09659 8.94982 6.25005 8.72015 6.44351 8.5267C6.63696 8.33324 6.86663 8.17979 7.11939 8.07509C7.37215 7.97039 7.64306 7.9165 7.91665 7.9165H32.0833C32.3569 7.9165 32.6278 7.97039 32.8806 8.07509C33.1333 8.17979 33.363 8.33324 33.5565 8.5267C33.7499 8.72015 33.9034 8.94982 34.0081 9.20258C34.1128 9.45534 34.1666 9.72625 34.1666 9.99984Z"
      fill="currentColor"
    />
    <path
      d="M34.7382 26.073L32.147 28.6642L29.558 26.0751C29.4608 25.9776 29.3454 25.9002 29.2182 25.8473C29.0911 25.7945 28.9548 25.7672 28.8171 25.767C28.6794 25.7669 28.543 25.7939 28.4158 25.8465C28.2885 25.8991 28.1729 25.9762 28.0755 26.0735C27.9782 26.1709 27.901 26.2866 27.8484 26.4139C27.7958 26.5411 27.7689 26.6775 27.7691 26.8152C27.7692 26.9529 27.7966 27.0892 27.8495 27.2163C27.9024 27.3435 27.9799 27.4589 28.0775 27.5561L30.6681 30.1467L28.0757 32.7391C27.8787 32.936 27.768 33.203 27.7679 33.4815C27.7678 33.76 27.8783 34.0271 28.0751 34.2242C28.1726 34.3221 28.2884 34.3999 28.4159 34.4531C28.5435 34.5063 28.6803 34.5339 28.8185 34.5342C28.9564 34.5349 29.093 34.5083 29.2206 34.456C29.3482 34.4037 29.4642 34.3267 29.562 34.2294L32.1564 31.635L34.7434 34.222C34.9484 34.427 35.2153 34.5313 35.4835 34.5309C35.6212 34.5313 35.7576 34.5044 35.8848 34.4517C36.0121 34.3991 36.1276 34.3218 36.2249 34.2243C36.3222 34.1269 36.3995 34.0113 36.4521 33.884C36.5048 33.7568 36.5318 33.6204 36.5318 33.4827C36.5317 33.3449 36.5045 33.2086 36.4517 33.0814C36.3989 32.9541 36.3216 32.8386 36.2242 32.7413L33.6369 30.154L36.2281 27.5629C36.6379 27.1531 36.635 26.4857 36.225 26.076C35.8152 25.6666 35.1477 25.6635 34.7382 26.073Z"
      fill="currentColor"
    />
  </svg>
);

type LoadingState = 'idle' | 'loading' | 'loaded' | 'error';

export const Image = forwardRef<HTMLImageElement, ImageProps>(
  (
    {
      src,
      alt,
      objectFit = 'cover',
      className = '',
      style,
      onLoad,
      onError,
      ...props
    },
    ref
  ) => {
    const [loadingState, setLoadingState] = useState<LoadingState>(src ? 'loading' : 'idle');

    useEffect(() => {
      if (src) {
        setLoadingState('loading');
      } else {
        setLoadingState('idle');
      }
    }, [src]);

    const handleLoad = (e: React.SyntheticEvent<HTMLImageElement>) => {
      setLoadingState('loaded');
      onLoad?.(e);
    };

    const handleError = (e: React.SyntheticEvent<HTMLImageElement>) => {
      setLoadingState('error');
      onError?.(e);
    };

    const containerClassNames = [
      'apron-image',
      loadingState !== 'loaded' && 'apron-image--placeholder',
      className,
    ]
      .filter(Boolean)
      .join(' ');

    // 无 src 时显示占位图标
    if (!src) {
      return (
        <div className={containerClassNames} style={style}>
          <div className="apron-image__placeholder">
            <span className="apron-image__icon">
              <PlaceholderIcon />
            </span>
          </div>
        </div>
      );
    }

    return (
      <div className={containerClassNames} style={style}>
        {/* 加载中或加载失败时显示占位内容 */}
        {loadingState !== 'loaded' && (
          <div className="apron-image__placeholder">
            <span className="apron-image__icon">
              {loadingState === 'error' ? <ErrorIcon /> : <PlaceholderIcon />}
            </span>
            <span className="apron-image__text">
              {loadingState === 'loading' && '图片加载中'}
              {loadingState === 'error' && '图片加载失败'}
            </span>
          </div>
        )}

        {/* 图片元素 */}
        <img
          ref={ref}
          src={src}
          alt={alt}
          className="apron-image__img"
          style={{ objectFit, opacity: loadingState === 'loaded' ? 1 : 0 }}
          onLoad={handleLoad}
          onError={handleError}
          {...props}
        />
      </div>
    );
  }
);

Image.displayName = 'Image';

